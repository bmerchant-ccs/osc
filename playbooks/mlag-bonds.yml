---
- name: Test playbook to update interface settings
  hosts: spine5600,spine4700,agg
  connection: ansible.netcommon.httpapi
  gather_facts: false
  vars:
    ansible_network_os: nvidia.nvue.httpapi
    ansible_httpapi_port: 8765
    ansible_httpapi_use_ssl: true
    ansible_httpapi_validate_certs: false

  tasks:
    - name: Create new revision
      nvidia.nvue.config:
        state: new
      register: revision

    - name: Set interface mlag trunk bonds
      nvidia.nvue.interface:
        state: merged
        revid: '{{ revision.revid }}'
        data:
          - id: '{{ item.id }}'
            bond:
              mlag:
                enable: 'on'
                id: '{{ item.mlagid }}'
              member: '{{ item.members }}'
            bridge:
              domain:
                - id: '{{ item.bridge }}'
                  vlan: '{{ item.vlan }}'
            type: 'bond'
      with_items: "{{ mlag_bonds }}"
      register: mlags

    - name: Set interface mlag hybrid bonds
      nvidia.nvue.interface:
        state: merged
        revid: '{{ revision.revid }}'
        data:
          - id: '{{ item.id }}'
            bond:
              mlag:
                enable: 'on'
                id: '{{ item.mlagid }}'
              member: '{{ item.members }}'
            bridge:
              domain:
                - id: '{{ item.bridge }}'
                  vlan: '{{ item.vlan }}'
                  untagged: '{{ item.untagged }}'
            type: 'bond'
      with_items: "{{ mlag_bonds_hybrid }}"
      register: hybridmlags

    - name: Apply new revision
      nvidia.nvue.config:
        state: apply
        revid: '{{ revision.revid }}'
        force: true
        wait: 10
      register: revision
